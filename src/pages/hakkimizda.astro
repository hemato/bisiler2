---
// === COMPONENT IMPORTS ===
import Layout from '../layouts/Layout.astro';
import { Award, Users, CheckCircle, ArrowRight } from 'lucide-react';

// === I18N IMPORTS ===
import { getLangFromUrl, getTranslations } from '../i18n/utils';

// === CONFIG IMPORTS ===
import { COMPANY_INFO, STATS_SECTIONS } from '../config/company';
import { CONTACT_INFO } from '../config/contact';
import { DOMAIN_CONFIG, getUrl } from '../config/domain';
import { getRoute } from '../utils/routes';

// === SEO OPTIMIZATION IMPORTS ===
import { AdvancedSEOManager } from '../utils/seo-advanced';
import {
  generateOrganizationSchema,
  generateBreadcrumbSchema,
  injectStructuredData
} from '../utils/structured-data';
import { generateOptimizedMetaDescription } from '../utils/seo';

// === PERFORMANCE OPTIMIZATION IMPORTS ===
import { initPerformanceOptimizations, resourceLoader } from '../utils/performance';

// === SECURITY IMPORTS ===
import { securityHeaders, xssProtection, cspUtils } from '../utils/security';

// === CONSTANTS ===
const ABOUT_PAGE_CONFIG = {
  PERFORMANCE: {
    METRICS_DELAY: 5000,
    LAZY_LOAD_MARGIN: '50px 0px',
    INTERSECTION_THRESHOLD: 0.1
  },
  SEO: {
    COMPANY_FOUNDING_YEAR: 2020,
    TEAM_SIZE: '10-50',
    EXPERTISE_AREAS: ['CRM', 'Web Development', 'Digital Transformation'],
    CERTIFICATIONS_COUNT: 8
  },
  IMAGES: {
    TEAM_IMAGE: 'https://images.pexels.com/photos/3184287/pexels-photo-3184287.jpeg?auto=compress&cs=tinysrgb&w=800'
  }
};

// === INITIALIZATION ===
const lang = getLangFromUrl(Astro.url);
const t = await getTranslations(lang);

// === SECURITY CONFIGURATION ===
const securityNonce = cspUtils.generateNonce();

// === SEO CONFIGURATION ===
const seoManager = new AdvancedSEOManager();

// === HELPER FUNCTIONS ===
function getAboutBenefits(lang: 'tr' | 'en') {
  return lang === 'en'
    ? ['expertise in CRM', 'proven track record', 'innovative solutions']
    : ['CRM uzmanlığı', 'kanıtlanmış başarı', 'yenilikçi çözümler'];
}

function getPageTitle(lang: 'tr' | 'en') {
  return `${t.nav.about} | ${COMPANY_INFO.name}`;
}

// === CONTENT GENERATION ===
// Generate enhanced meta description
const optimizedDescription = generateOptimizedMetaDescription(
  lang === 'en' ? 'About our CRM consulting company' : 'CRM danışmanlık şirketimiz hakkında',
  getAboutBenefits(lang),
  lang === 'en' ? 'Turkey' : 'Türkiye',
  lang
);

// === STRUCTURED DATA GENERATION ===
// Generate Organization Schema
const organizationSchema = generateOrganizationSchema(lang);

// Generate AboutPage Schema
const aboutPageSchema = {
  '@context': 'https://schema.org',
  '@type': 'AboutPage',
  name: getPageTitle(lang),
  description: optimizedDescription,
  url: getUrl(getRoute(lang, 'about')),
  mainEntity: {
    '@type': 'Organization',
    name: COMPANY_INFO.name,
    foundingDate: COMPANY_INFO.foundingYear,
    numberOfEmployees: COMPANY_INFO.employeeCount,
    description: COMPANY_INFO.description[lang],
    expertise: ABOUT_PAGE_CONFIG.SEO.EXPERTISE_AREAS,
    address: {
      '@type': 'PostalAddress',
      streetAddress: CONTACT_INFO.address.street,
      addressLocality: CONTACT_INFO.address.city,
      addressRegion: CONTACT_INFO.address.district,
      postalCode: CONTACT_INFO.address.postalCode,
      addressCountry: CONTACT_INFO.address.country
    }
  },
  breadcrumb: {
    '@type': 'BreadcrumbList',
    itemListElement: [
      {
        '@type': 'ListItem',
        position: 1,
        name: lang === 'en' ? 'Home' : 'Anasayfa',
        item: getUrl(getRoute(lang, 'home'))
      },
      {
        '@type': 'ListItem',
        position: 2,
        name: t.nav.about,
        item: getUrl(getRoute(lang, 'about'))
      }
    ]
  }
};

// Generate WebPage Schema using AdvancedSEOManager
const pageSchemas = seoManager.generateSchemasForPage('about', {
  page: {
    name: getPageTitle(lang),
    description: optimizedDescription,
    url: getUrl(getRoute(lang, 'about')),
    primaryImageOfPage: ABOUT_PAGE_CONFIG.IMAGES.TEAM_IMAGE,
    breadcrumb: [
      { name: lang === 'en' ? 'Home' : 'Anasayfa', url: getRoute(lang, 'home') },
      { name: t.nav.about, url: getRoute(lang, 'about') }
    ]
  },
  baseUrl: DOMAIN_CONFIG.baseUrl
}, lang);

// === COMBINE ALL STRUCTURED DATA ===
const allStructuredData = [
  organizationSchema,
  aboutPageSchema,
  ...pageSchemas
];
---

<Layout
  title={getPageTitle(lang)}
  description={optimizedDescription}
  structuredData={allStructuredData}
  ogImage={DOMAIN_CONFIG.images.ogImage}
  canonical={getUrl(getRoute(lang, 'about'))}
  breadcrumbs={[
    { name: lang === 'en' ? 'Home' : 'Anasayfa', url: getRoute(lang, 'home') },
    { name: t.nav.about, url: getRoute(lang, 'about') }
  ]}
>
  <div class="bg-gradient-to-br from-primary-50 to-secondary-50 py-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-16">
        <h1 class="text-4xl font-bold text-secondary-900 mb-4">
          {t.about.title}
        </h1>
        <p class="text-xl text-secondary-600 max-w-2xl mx-auto">
          {t.about.subtitle}
        </p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
        <div>
          <p class="text-lg text-secondary-700 leading-relaxed mb-8">
            {t.about.content}
          </p>
          
          <div class="mb-8">
            <h3 class="text-2xl font-semibold text-secondary-900 mb-4">
              {t.about.experience.title}
            </h3>
            <p class="text-secondary-700 leading-relaxed">
              {t.about.experience.content}
            </p>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {STATS_SECTIONS.about[lang].map((stat) => (
              <div class="bg-white p-6 rounded-lg shadow-sm">
                <div class="text-3xl font-bold text-primary-600 mb-2">{stat.value}</div>
                <div class="text-secondary-700">{stat.label}</div>
              </div>
            ))}
          </div>
        </div>

        <div class="relative">
          <img
            src="https://images.pexels.com/photos/3184287/pexels-photo-3184287.jpeg?auto=compress&cs=tinysrgb&w=800"
            alt={lang === 'en' ? 'TechCorp expert team working on CRM and web development projects' : 'TechCorp uzman ekibi CRM ve web geliştirme projeleri üzerinde çalışırken'}
            class="rounded-2xl shadow-2xl w-full"
            loading="lazy"
          />
        </div>
      </div>
    </div>
  </div>

  <!-- Expertise Section -->
  <section class="py-20 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
        <div>
          <h2 class="text-3xl font-bold text-secondary-900 mb-8">
            {t.about.expertise.title}
          </h2>
          <div class="grid grid-cols-1 gap-4">
            {t.about.expertise.items.map((item) => (
              <div class="flex items-center">
                <CheckCircle className="w-5 h-5 text-green-600 mr-3 flex-shrink-0" />
                <span class="text-secondary-700">{item}</span>
              </div>
            ))}
          </div>
        </div>

        <div>
          <h2 class="text-3xl font-bold text-secondary-900 mb-8">
            {t.about.certifications.title}
          </h2>
          <div class="grid grid-cols-1 gap-4">
            {t.about.certifications.items.map((cert) => (
              <div class="flex items-center bg-primary-50 p-4 rounded-lg">
                <Award className="w-5 h-5 text-primary-600 mr-3 flex-shrink-0" />
                <span class="text-secondary-700 font-medium">{cert}</span>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Working Approach Section -->
  <section class="py-20 bg-secondary-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-16">
        <h2 class="text-3xl font-bold text-secondary-900 mb-4">
          {t.about.approach.title}
        </h2>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-5 gap-8">
        {t.about.approach.steps.map((step, index) => (
          <div class="text-center relative">
            <div class="w-16 h-16 bg-primary-600 rounded-full flex items-center justify-center mx-auto mb-6 text-white font-bold text-xl">
              {index + 1}
            </div>
            <h3 class="text-lg font-semibold text-secondary-900 mb-3">
              {step.title}
            </h3>
            <p class="text-secondary-600 text-sm">
              {step.description}
            </p>
            {index < t.about.approach.steps.length - 1 && (
              <ArrowRight className="hidden md:block absolute top-8 -right-4 w-6 h-6 text-primary-300" />
            )}
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Values Section -->
  <section class="py-20 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-16">
        <h2 class="text-3xl font-bold text-secondary-900 mb-4">
          {lang === 'en' ? 'Our Values' : 'Değerlerimiz'}
        </h2>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div class="text-center">
          <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <div class="w-8 h-8 bg-primary-600 rounded-full"></div>
          </div>
          <h3 class="text-xl font-semibold text-secondary-900 mb-4">
            {lang === 'en' ? 'Innovation' : 'İnovasyon'}
          </h3>
          <p class="text-secondary-600">
            {lang === 'en' 
              ? 'We constantly explore new technologies and methods to provide the best solutions for our clients.'
              : 'Müşterilerimize en iyi çözümleri sunmak için sürekli yeni teknolojiler ve yöntemler keşfediyoruz.'
            }
          </p>
        </div>

        <div class="text-center">
          <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <div class="w-8 h-8 bg-primary-600 rounded-full"></div>
          </div>
          <h3 class="text-xl font-semibold text-secondary-900 mb-4">
            {lang === 'en' ? 'Quality' : 'Kalite'}
          </h3>
          <p class="text-secondary-600">
            {lang === 'en' 
              ? 'Every project is executed with the highest standards of quality and attention to detail.'
              : 'Her proje en yüksek kalite standartları ve detay odaklı yaklaşımla execute edilir.'
            }
          </p>
        </div>

        <div class="text-center">
          <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <div class="w-8 h-8 bg-primary-600 rounded-full"></div>
          </div>
          <h3 class="text-xl font-semibold text-secondary-900 mb-4">
            {lang === 'en' ? 'Partnership' : 'Ortaklık'}
          </h3>
          <p class="text-secondary-600">
            {lang === 'en' 
              ? 'We build long-term partnerships with our clients, supporting their growth journey.'
              : 'Müşterilerimizle uzun vadeli ortaklıklar kurarak büyüme yolculuklarını destekliyoruz.'
            }
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="py-20 bg-primary-600">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="text-3xl font-bold text-white mb-6">
        {lang === 'en' ? 'Ready to Work With Us?' : 'Bizimle Çalışmaya Hazır mısınız?'}
      </h2>
      <p class="text-xl text-primary-100 mb-8">
        {lang === 'en' 
          ? 'Let\'s discuss your project and create a customized solution for your business.'
          : 'Projenizi konuşalım ve işletmeniz için özelleştirilmiş bir çözüm oluşturalım.'
        }
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a
          href={getRoute(lang, 'contact')}
          class="inline-flex items-center px-8 py-4 bg-white text-primary-600 font-semibold rounded-lg hover:bg-primary-50 transition-all duration-200 transform hover:scale-105"
        >
          {lang === 'en' ? 'Start Your Project' : 'Projenizi Başlatın'}
        </a>
        <a
          href={getRoute(lang, 'services')}
          class="inline-flex items-center px-8 py-4 border-2 border-white text-white font-semibold rounded-lg hover:bg-white hover:text-primary-600 transition-all duration-200"
        >
          {lang === 'en' ? 'View Services' : 'Hizmetleri Görüntüle'}
        </a>
      </div>
    </div>
  </section>
</Layout>

<!-- Performance & Security Optimization Script -->
<script is:inline>
  // Performance & Security optimization for about page
  document.addEventListener('DOMContentLoaded', function() {
    
    // === SECURITY FUNCTIONS ===
    function sanitizeInput(input) {
      if (!input || typeof input !== 'string') return '';
      return input
        .replace(/[<>]/g, '')
        .replace(/javascript:/gi, '')
        .replace(/on\w+=/gi, '')
        .trim();
    }
    
    function isValidUrl(url) {
      try {
        var urlObj = new URL(url, window.location.origin);
        return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
      } catch (e) {
        return false;
      }
    }
    
    // Rate limiting for interactions
    var interactionTimestamps = [];
    var RATE_LIMIT_WINDOW = 60000;
    var MAX_INTERACTIONS = 10;
    
    function isRateLimited() {
      var now = Date.now();
      interactionTimestamps = interactionTimestamps.filter(function(time) {
        return now - time < RATE_LIMIT_WINDOW;
      });
      
      if (interactionTimestamps.length >= MAX_INTERACTIONS) {
        console.warn('Interaction rate limit exceeded');
        return true;
      }
      
      interactionTimestamps.push(now);
      return false;
    }
    
    // Expose security functions globally
    window.aboutPageSecurity = {
      sanitizeInput: sanitizeInput,
      isValidUrl: isValidUrl,
      isRateLimited: isRateLimited
    };
    
    // === PERFORMANCE FUNCTIONS ===
    function addPreloadLink(href, as, type) {
      if (document.querySelector('link[href="' + href + '"]')) return;
      var link = document.createElement('link');
      link.rel = 'preload';
      link.href = href;
      link.as = as;
      if (type) link.type = type;
      link.crossOrigin = 'anonymous';
      document.head.appendChild(link);
    }
    
    function addDnsPrefetch(domain) {
      if (document.querySelector('link[href="' + domain + '"]')) return;
      var link = document.createElement('link');
      link.rel = 'dns-prefetch';
      link.href = domain;
      document.head.appendChild(link);
    }
    
    function addPrefetch(href) {
      if (document.querySelector('link[href="' + href + '"]')) return;
      var link = document.createElement('link');
      link.rel = 'prefetch';
      link.href = href;
      document.head.appendChild(link);
    }
    
    // Performance metrics
    var metrics = { lcp: 0, fid: 0, cls: 0 };
    
    // Core Web Vitals monitoring
    if (window.PerformanceObserver) {
      try {
        new PerformanceObserver(function(list) {
          var entries = list.getEntries();
          if (entries.length > 0) {
            metrics.lcp = entries[entries.length - 1].startTime;
          }
        }).observe({ entryTypes: ['largest-contentful-paint'] });
      } catch (e) {
        console.warn('LCP observer failed');
      }
      
      try {
        new PerformanceObserver(function(list) {
          list.getEntries().forEach(function(entry) {
            metrics.fid = entry.processingStart - entry.startTime;
          });
        }).observe({ entryTypes: ['first-input'] });
      } catch (e) {
        console.warn('FID observer failed');
      }
    }
    
    // === APPLY OPTIMIZATIONS ===
    // DNS prefetch for external resources
    addDnsPrefetch('//images.pexels.com');
    addDnsPrefetch('//fonts.googleapis.com');
    
    // Prefetch next likely pages
    addPrefetch('/hizmetlerimiz');
    addPrefetch('/iletisim');
    addPrefetch('/referanslar');
    
    // === ENHANCED INTERACTIONS ===
    // Stats animation with intersection observer
    if (window.IntersectionObserver) {
      var statsObserver = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting && !isRateLimited()) {
            entry.target.classList.add('animate-stats');
            statsObserver.unobserve(entry.target);
          }
        });
      }, { threshold: 0.1 });
      
      document.querySelectorAll('.bg-white.p-6.rounded-lg').forEach(function(stat) {
        statsObserver.observe(stat);
      });
    }
    
    // Values section animation
    if (window.IntersectionObserver) {
      var valuesObserver = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting && !isRateLimited()) {
            entry.target.classList.add('animate-fade-in');
            valuesObserver.unobserve(entry.target);
          }
        });
      }, { threshold: 0.2 });
      
      document.querySelectorAll('.text-center > .w-16.h-16').forEach(function(value) {
        valuesObserver.observe(value.parentElement);
      });
    }
    
    // Process steps animation
    if (window.IntersectionObserver) {
      var stepsObserver = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting && !isRateLimited()) {
            var delay = Array.from(entry.target.parentElement.children).indexOf(entry.target) * 200;
            setTimeout(function() {
              entry.target.classList.add('animate-step-up');
            }, delay);
            stepsObserver.unobserve(entry.target);
          }
        });
      }, { threshold: 0.3 });
      
      document.querySelectorAll('.text-center.relative').forEach(function(step) {
        stepsObserver.observe(step);
      });
    }
    
    // === ANALYTICS ===
    setTimeout(function() {
      console.log('📊 About Page Metrics:', metrics);
      
      if (window.gtag) {
        // Track page-specific events
        window.gtag('event', 'about_page_view', {
          page_title: document.title,
          engagement_time_msec: 5000
        });
        
        if (metrics.lcp > 0) {
          window.gtag('event', 'web_vitals', {
            metric_name: 'LCP',
            metric_value: Math.round(metrics.lcp),
            metric_unit: 'ms',
            page_type: 'about'
          });
        }
      }
    }, 5000);
  });
</script>

<!-- Enhanced CSS for animations -->
<style>
  /* About page specific animations */
  .animate-stats {
    animation: statsSlideUp 0.8s ease-out;
  }
  
  .animate-fade-in {
    animation: fadeIn 0.6s ease-out;
  }
  
  .animate-step-up {
    animation: stepUp 0.8s ease-out;
  }
  
  @keyframes statsSlideUp {
    from {
      opacity: 0;
      transform: translateY(30px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.9);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
  
  @keyframes stepUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Performance optimizations */
  .bg-white.p-6.rounded-lg,
  .text-center.relative,
  .w-16.h-16 {
    will-change: transform;
  }
  
  /* Image optimization hints */
  img {
    content-visibility: auto;
    contain-intrinsic-size: 800px 600px;
  }
  
  /* Lazy loading enhancements */
  .lazy-section {
    content-visibility: auto;
    contain-intrinsic-size: 0 500px;
  }
</style>
